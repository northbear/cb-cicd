pipeline {
    agent any
    triggers {
        pollSCM('H/2 * * * 1-5')
    }
    environment {
        registry = "northbear/server-image"
        registryCredential = 'cb-access-dockerhub'
        dockerImage = ''
        dockerImageName = 'morse-responder'
    }
    stages {
        stage("Prepare Workspace") {
            steps {
	    	echo 'Prepare'
                git 'https://github.com/northbear/cb-ms-morse.git'
	    }
        }
        stage("Build Image")    {
            steps {
	        echo 'Build'
                script {
                    dockerImage = docker.build(dockerImageName, 'morse-responder/.')
                }
	    }
        }
        stage("Run And Verify") {
            steps {
	    	echo 'Test'
	    }
        } 
        stage("Publish Image")  {
            steps {
	    	echo 'Push image to Repo'
                script {
                    docker.withRegistry( '', registryCredential ) {
                        dockerImage.push(":${env.BUILD_ID}")
                    }
                }
	    }
        }
        stage("Clean Up")  {
            steps {
	    	echo 'Remove containers'
                // sh 'docker rmi ${dockerImageName}'
	    }
        }
    }
}

